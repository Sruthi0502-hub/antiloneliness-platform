<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentimate ‚Äì Your AI Companion</title>
    <meta name="description" content="Sentimate ‚Äî a warm AI companion that listens, talks, and cares.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&family=Lora:ital,wght@0,400;0,600;1,400&display=swap"
        rel="stylesheet">

    <style>
        /* ================================================================
   SENTIMATE ‚Äî Complete Self-Contained Chat UI
   Soft Blue #7FA1FF + Lavender #CDB4DB + Clean White
   ================================================================ */

        /* ‚îÄ‚îÄ Reset ‚îÄ‚îÄ */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            height: 100%;
        }

        /* ================================================================
   ¬ß 1  ANIMATED BACKGROUND KEYFRAMES
   ================================================================ */
        @keyframes bgShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes orbFloat {
            0% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(30px, -20px) scale(1.04);
            }

            50% {
                transform: translate(10px, -40px) scale(1.08);
            }

            75% {
                transform: translate(-20px, -15px) scale(1.03);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes orbFloat2 {
            0% {
                transform: translate(0, 0) scale(1);
            }

            30% {
                transform: translate(-25px, 18px) scale(1.05);
            }

            60% {
                transform: translate(15px, 35px) scale(1.02);
            }

            80% {
                transform: translate(20px, -10px) scale(1.06);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes glow {

            0%,
            100% {
                opacity: .45;
            }

            50% {
                opacity: .75;
            }
        }

        @keyframes pageEntrance {
            from {
                opacity: 0;
                transform: translateY(28px) scale(.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes slideFromRight {
            from {
                opacity: 0;
                transform: translateX(40px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideFromLeft {
            from {
                opacity: 0;
                transform: translateX(-40px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes dotBounce {

            0%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-8px);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: .5;
                transform: scale(1.4);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-12px);
            }
        }

        @keyframes fadeInOut {

            0%,
            100% {
                opacity: .45;
            }

            50% {
                opacity: 1;
            }
        }

        @keyframes pulseRing {
            0% {
                box-shadow: 0 0 0 0 rgba(205, 180, 219, .6);
            }

            100% {
                box-shadow: 0 0 0 14px rgba(205, 180, 219, 0);
            }
        }

        /* ================================================================
   ¬ß 2  BODY + FLOATING ORBS
   ================================================================ */
        body {
            font-family: 'Nunito', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(-45deg,
                    #eef2ff, #f5eefa, #fdf0ee, #e8f0fe, #f0ecff);
            background-size: 400% 400%;
            animation: bgShift 18s ease infinite;
            color: #1a1d2e;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Orb 1 ‚Äî large lavender-blue, top-left */
        body::before {
            content: '';
            position: fixed;
            top: -120px;
            left: -100px;
            width: 560px;
            height: 560px;
            border-radius: 50%;
            background: radial-gradient(circle at center,
                    rgba(127, 161, 255, .28) 0%,
                    rgba(127, 161, 255, .12) 50%,
                    transparent 80%);
            animation: orbFloat 22s ease-in-out infinite, glow 9s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
            will-change: transform, opacity;
        }

        /* Orb 2 ‚Äî smaller peach-lavender, bottom-right */
        body::after {
            content: '';
            position: fixed;
            bottom: -80px;
            right: -80px;
            width: 420px;
            height: 420px;
            border-radius: 50%;
            background: radial-gradient(circle at center,
                    rgba(205, 180, 219, .22) 0%,
                    rgba(127, 161, 255, .10) 55%,
                    transparent 80%);
            animation: orbFloat2 17s ease-in-out infinite, glow 11s ease-in-out infinite 3s;
            z-index: 0;
            pointer-events: none;
            will-change: transform, opacity;
        }

        /* ================================================================
   ¬ß 3  NAVBAR
   ================================================================ */
        .navbar {
            background: rgba(255, 255, 255, .82);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-bottom: 1.5px solid rgba(200, 200, 230, .35);
            padding: 0 28px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 300;
            box-shadow: 0 2px 12px rgba(127, 161, 255, .10);
            flex-shrink: 0;
        }

        .nav-brand {
            font-family: 'Lora', serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: #7FA1FF;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -.2px;
        }

        .nav-brand-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, .6);
            animation: blink 2.5s ease-in-out infinite;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            color: #4a4f6b;
            padding: 7px 14px;
            border-radius: 20px;
            transition: background .18s, color .18s;
        }

        .nav-link:hover {
            background: #eef2ff;
            color: #7FA1FF;
        }

        .nav-link.active {
            background: #eef2ff;
            color: #7FA1FF;
        }

        .nav-user {
            font-size: .95rem;
            font-weight: 600;
            color: #7FA1FF;
            padding: 6px 14px;
            border: 1.5px solid #eef2ff;
            border-radius: 20px;
            background: #eef2ff;
        }

        /* ================================================================
   ¬ß 4  PAGE SHELL
   ================================================================ */
        .page {
            flex: 1;
            display: flex;
            align-items: stretch;
            justify-content: center;
            padding: 24px 16px;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        /* ================================================================
   ¬ß 5  CHAT CONTAINER ‚Äî GLASSMORPHISM
   ================================================================ */
        .chat-container {
            width: 100%;
            max-width: 820px;
            /* ‚ïê‚ïê‚ïê GLASS EFFECT ‚ïê‚ïê‚ïê */
            background: rgba(255, 255, 255, .62);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1.5px solid rgba(255, 255, 255, .72);
            box-shadow:
                0 8px 32px rgba(127, 161, 255, .18),
                0 2px 8px rgba(0, 0, 0, .06),
                inset 0 1px 0 rgba(255, 255, 255, .85);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* ‚ïê‚ïê‚ïê PAGE ENTRANCE ‚ïê‚ïê‚ïê */
            animation: pageEntrance .55s cubic-bezier(.22, .68, 0, 1.2) both;
        }

        /* ================================================================
   ¬ß 6  CHAT HEADER
   ================================================================ */
        .chat-header {
            padding: 18px 24px;
            border-bottom: 1.5px solid rgba(200, 200, 230, .28);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, .55);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .bot-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7FA1FF 0%, #CDB4DB 55%, #f0836e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #fff;
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(127, 161, 255, .35);
        }

        .chat-header-info h2 {
            font-family: 'Lora', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #1a1d2e;
            line-height: 1.2;
        }

        .chat-header-info p {
            font-size: .95rem;
            color: #8b90a7;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 3px 0 0;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            display: inline-block;
            box-shadow: 0 0 6px rgba(34, 197, 94, .55);
            animation: blink 2.5s ease-in-out infinite;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ctrl {
            padding: 7px 13px;
            font-size: .95rem;
            font-weight: 600;
            font-family: inherit;
            border-radius: 20px;
            border: 1.5px solid rgba(200, 200, 230, .45);
            background: rgba(255, 255, 255, .6);
            color: #4a4f6b;
            cursor: pointer;
            transition: all .2s;
        }

        .ctrl:hover {
            border-color: #7FA1FF;
            color: #7FA1FF;
            background: #eef2ff;
        }

        .ctrl.active {
            border-color: #7FA1FF;
            color: #7FA1FF;
            background: #eef2ff;
        }

        .ctrl-select {
            appearance: none;
            -webkit-appearance: none;
        }

        /* ================================================================
   ¬ß 7  MESSAGES AREA
   ================================================================ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            background: linear-gradient(180deg,
                    rgba(238, 242, 255, .70) 0%,
                    rgba(245, 238, 250, .75) 100%);
            scrollbar-width: thin;
            scrollbar-color: #c5d3ff transparent;
        }

        .chat-messages::-webkit-scrollbar {
            width: 5px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c5d3ff;
            border-radius: 3px;
        }

        /* ‚îÄ‚îÄ Message row ‚îÄ‚îÄ */
        .message {
            display: flex;
            gap: 12px;
            max-width: 100%;
        }

        /* USER ‚Äî slides from right */
        .message.user {
            flex-direction: row-reverse;
            animation: slideFromRight .38s cubic-bezier(.22, .68, 0, 1.15) both;
        }

        /* BOT ‚Äî slides from left */
        .message.bot {
            flex-direction: row;
            animation: slideFromLeft .38s cubic-bezier(.22, .68, 0, 1.15) both;
        }

        /* History messages ‚Äî no animation */
        .message.no-anim {
            animation: none !important;
        }

        /* Avatar */
        .msg-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
            align-self: flex-end;
        }

        .message.user .msg-avatar {
            background: linear-gradient(135deg, #7FA1FF, #a8bfff);
            color: #fff;
            box-shadow: 0 3px 10px rgba(127, 161, 255, .3);
        }

        .message.bot .msg-avatar {
            background: linear-gradient(135deg, #CDB4DB, #e2d1f0);
            color: #fff;
            box-shadow: 0 3px 10px rgba(205, 180, 219, .3);
        }

        /* Bubble group */
        .msg-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 68%;
        }

        .message.user .msg-group {
            align-items: flex-end;
        }

        .message.bot .msg-group {
            align-items: flex-start;
        }

        /* Bubble */
        .bubble {
            padding: 14px 20px;
            border-radius: 20px;
            font-size: 1.1rem;
            line-height: 1.65;
            word-break: break-word;
            transition: box-shadow .25s ease, transform .2s ease;
        }

        .bubble:hover {
            transform: translateY(-2px);
        }

        /* User bubble ‚Äî Soft Blue */
        .message.user .bubble {
            background: linear-gradient(135deg, #7FA1FF 0%, #a8bfff 100%);
            color: #fff;
            border-bottom-right-radius: 5px;
            box-shadow: 0 4px 18px rgba(127, 161, 255, .35);
            text-shadow: 0 1px 2px rgba(0, 0, 0, .12);
        }

        .message.user .bubble:hover {
            box-shadow: 0 6px 24px rgba(127, 161, 255, .45);
        }

        /* Bot bubble ‚Äî Glass with Lavender accent */
        .message.bot .bubble {
            background: rgba(255, 255, 255, .85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #2d2f42;
            border: 1.5px solid rgba(205, 180, 219, .38);
            border-left: 4px solid #CDB4DB;
            border-bottom-left-radius: 5px;
            box-shadow: 0 4px 16px rgba(205, 180, 219, .20);
        }

        .message.bot .bubble:hover {
            box-shadow: 0 6px 22px rgba(205, 180, 219, .30);
        }

        /* Timestamp */
        .msg-time {
            font-size: .75rem;
            color: #8b90a7;
            padding: 0 4px;
            letter-spacing: .01em;
        }

        /* ‚îÄ‚îÄ Typing indicator ‚îÄ‚îÄ */
        .typing-indicator .bubble {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 14px 20px;
        }

        .typing-label {
            font-size: .9rem;
            color: #8b90a7;
            font-style: italic;
            white-space: nowrap;
            margin-right: 2px;
            animation: fadeInOut 1.8s ease-in-out infinite;
        }

        .dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            animation: dotBounce 1.3s ease-in-out infinite;
        }

        .dot:nth-child(2) {
            background: #7FA1FF;
        }

        .dot:nth-child(3) {
            background: #CDB4DB;
            animation-delay: .18s;
        }

        .dot:nth-child(4) {
            background: #a8bfff;
            animation-delay: .36s;
        }

        /* ‚îÄ‚îÄ Welcome / empty state ‚îÄ‚îÄ */
        .empty-state {
            margin: auto;
            text-align: center;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
        }

        .empty-icon {
            font-size: 4em;
            animation: float 3.5s ease-in-out infinite;
        }

        .empty-state h3 {
            font-family: 'Lora', serif;
            font-size: 1.65rem;
            font-weight: 700;
            background: linear-gradient(135deg, #7FA1FF 0%, #CDB4DB 55%, #f0836e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .empty-state p {
            font-size: 1.1rem;
            color: #4a4f6b;
            max-width: 380px;
            line-height: 1.65;
            margin: 0;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 4px;
        }

        .chip {
            padding: 9px 18px;
            background: rgba(205, 180, 219, .18);
            border: 1.5px solid rgba(205, 180, 219, .55);
            border-radius: 22px;
            font-size: .95rem;
            font-weight: 600;
            color: #a88cb5;
            cursor: pointer;
            font-family: inherit;
            transition: background .18s, transform .18s, box-shadow .18s;
        }

        .chip:hover {
            background: rgba(205, 180, 219, .32);
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(205, 180, 219, .30);
        }

        /* ================================================================
   ¬ß 8  VOICE STATUS BAR
   ================================================================ */
        .voice-bar {
            display: none;
            padding: 9px 24px;
            background: rgba(254, 243, 199, .85);
            border-top: 1.5px solid rgba(232, 160, 48, .35);
            font-size: .95rem;
            font-weight: 600;
            color: #92400e;
            text-align: center;
        }

        .voice-bar.visible {
            display: block;
        }

        /* ================================================================
   ¬ß 9  INPUT AREA ‚Äî GLASS
   ================================================================ */
        .input-area {
            padding: 16px 24px;
            border-top: 1.5px solid rgba(200, 200, 230, .28);
            background: rgba(255, 255, 255, .75);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        /* Mic button */
        .mic-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: 1.5px solid rgba(205, 180, 219, .45);
            background: rgba(245, 238, 250, .65);
            color: #7FA1FF;
            font-size: 1.25em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform .2s ease, box-shadow .2s ease,
                background .2s ease, border-color .2s ease;
            outline: none;
        }

        .mic-btn:hover {
            border-color: #7FA1FF;
            background: #eef2ff;
            transform: scale(1.12);
            box-shadow: 0 4px 16px rgba(127, 161, 255, .30);
        }

        .mic-btn:active {
            transform: scale(.93);
            box-shadow: none;
        }

        .mic-btn.recording {
            background: #fef2f2;
            border-color: #ef4444;
            color: #ef4444;
            animation: pulseRing 1.2s ease-in-out infinite;
        }

        .mic-btn:disabled {
            background: #f1f1f1;
            border-color: #ddd;
            color: #bbb;
            cursor: not-allowed;
            animation: none;
        }

        /* Text input */
        .msg-input {
            flex: 1;
            padding: 13px 20px;
            font-size: 1.1rem;
            font-family: inherit;
            border: 1.5px solid rgba(205, 180, 219, .45);
            border-radius: 16px;
            background: rgba(255, 255, 255, .78);
            color: #1a1d2e;
            transition: border-color .25s, box-shadow .25s, background .2s;
            line-height: 1.5;
            outline: none;
        }

        .msg-input:focus {
            border-color: #7FA1FF;
            background: rgba(255, 255, 255, .96);
            box-shadow: 0 0 0 4px rgba(127, 161, 255, .14);
        }

        .msg-input::placeholder {
            color: #a0a5bf;
        }

        /* Send button */
        .send-btn {
            height: 52px;
            min-width: 100px;
            padding: 0 20px;
            background: linear-gradient(135deg, #7FA1FF 0%, #a8bfff 100%);
            color: #fff;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            /* ‚ïê‚ïê‚ïê BUTTON TRANSITIONS ‚ïê‚ïê‚ïê */
            transition: transform .22s ease, box-shadow .22s ease, filter .22s ease;
            box-shadow: 0 4px 18px rgba(127, 161, 255, .40);
            flex-shrink: 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, .12);
        }

        .send-btn:hover:not(:disabled) {
            /* grow + brighten */
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 26px rgba(127, 161, 255, .52);
            filter: brightness(1.08);
        }

        .send-btn:active:not(:disabled) {
            /* press-down */
            transform: translateY(1px) scale(.97);
            box-shadow: 0 2px 8px rgba(127, 161, 255, .25);
            filter: brightness(.96);
        }

        .send-btn:disabled {
            background: #d0d8f5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            filter: none;
        }

        /* ================================================================
   ¬ß 10  ACCESSIBILITY
   ================================================================ */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid #7FA1FF;
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion:reduce) {

            *,
            *::before,
            *::after {
                animation-duration: .01ms !important;
                transition-duration: .01ms !important;
            }
        }

        /* ================================================================
   ¬ß 11  RESPONSIVE
   ================================================================ */
        @media (max-width:768px) {
            .page {
                padding: 0;
            }

            .chat-container {
                border-radius: 0;
                border: none;
                height: 100%;
            }

            .chat-header {
                padding: 12px 16px;
            }

            .chat-messages {
                padding: 16px;
            }

            .msg-group {
                max-width: 85%;
            }

            .bubble {
                font-size: 1rem;
                padding: 12px 16px;
            }

            .input-area {
                flex-wrap: wrap;
                padding: 10px 14px;
                gap: 8px;
            }

            .msg-input {
                flex: none;
                width: 100%;
                order: 1;
            }

            .mic-btn {
                order: 0;
            }

            .send-btn {
                flex: 1;
                order: 2;
                min-width: unset;
            }
        }

        @media (max-width:480px) {
            .navbar {
                padding: 0 14px;
                height: 56px;
            }

            .nav-brand {
                font-size: 1.15rem;
            }

            .nav-link {
                font-size: .82rem;
                padding: 5px 9px;
            }

            .bot-avatar {
                width: 42px;
                height: 42px;
                font-size: 1.2em;
            }
        }
    </style>
</head>

<body>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <nav class="navbar" role="navigation" aria-label="Site navigation">
        <div class="nav-brand">
            <div class="nav-brand-dot"></div>
            Sentimate
        </div>
        <div class="nav-links">
            <a href="/" class="nav-link">Home</a>
            <a href="/chat" class="nav-link active">Chat</a>
            <a href="/medication" class="nav-link">Reminders</a>
            <a href="/games" class="nav-link">Games</a>
            {% if session.username %}
            <span class="nav-user">üë§ {{ session.username }}</span>
            <a href="/logout" class="nav-link" style="color:#ef4444;">Logout</a>
            {% endif %}
        </div>
    </nav>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="page">
        <div class="chat-container">

            <!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
            <div class="chat-header">
                <div class="chat-header-left">
                    <div class="bot-avatar" aria-hidden="true">ü§ó</div>
                    <div class="chat-header-info">
                        <h2>Sentimate ‚Äì Your AI Companion</h2>
                        <p>
                            <span class="online-dot" aria-hidden="true"></span>
                            Always here for you
                        </p>
                    </div>
                </div>
                <div class="header-controls">
                    <select class="ctrl ctrl-select" id="langSelect" aria-label="Choose language" title="Language">
                        <option value="english">üá¨üáß English</option>
                        <option value="tamil">üáÆüá≥ Tamil</option>
                    </select>
                    <button class="ctrl active" id="voiceToggle" onclick="toggleVoice()" aria-pressed="true"
                        title="Toggle voice responses">
                        üîä Voice
                    </button>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ -->
            <div class="chat-messages" id="chatBox" role="log" aria-live="polite" aria-label="Conversation">

                {% if history %}
                {% for msg in history %}
                <div class="message {{ msg.sender }} no-anim">
                    <div class="msg-avatar" aria-hidden="true">
                        {{ 'üë§' if msg.sender == 'user' else 'ü§ó' }}
                    </div>
                    <div class="msg-group">
                        <div class="bubble">{{ msg.message }}</div>
                        <div class="msg-time">{{ msg.timestamp[11:16] }}</div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">üå∏</div>
                    <h3>Hello! I'm so glad you're here.</h3>
                    <p>
                        Feel free to type a message or tap the microphone ‚Äî
                        I'm always here to listen and chat with you.
                    </p>
                    <div class="suggestions" id="suggestions">
                        <button class="chip" onclick="suggest('How are you today?')">üòä How are you?</button>
                        <button class="chip" onclick="suggest('Tell me something nice')">üåº Say something nice</button>
                        <button class="chip" onclick="suggest('I feel a bit lonely')">üíô I feel lonely</button>
                        <button class="chip" onclick="suggest('Share a Tamil story')">üìñ Tamil story</button>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- ‚îÄ‚îÄ VOICE STATUS ‚îÄ‚îÄ -->
            <div class="voice-bar" id="voiceBar" role="status" aria-live="polite"></div>

            <!-- ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ -->
            <div class="input-area">
                <button class="mic-btn" id="micBtn" onclick="toggleMic()" aria-label="Voice input"
                    title="Click to speak">
                    üé§
                </button>
                <input class="msg-input" type="text" id="userInput" placeholder="Type your message here‚Ä¶"
                    autocomplete="off" aria-label="Your message">
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" aria-label="Send">
                    Send ‚û§
                </button>
            </div>

        </div><!-- /chat-container -->
    </div><!-- /page -->

    <audio id="ttsAudio" style="display:none;"></audio>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
        // ‚îÄ‚îÄ Refs ‚îÄ‚îÄ
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const voiceToggle = document.getElementById('voiceToggle');
        const langSelect = document.getElementById('langSelect');
        const voiceBar = document.getElementById('voiceBar');
        const ttsAudio = document.getElementById('ttsAudio');

        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let voiceOn = true;
        let isRecording = false;
        let recognition = null;

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
        const clock = () =>
            new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        function showBar(msg) { voiceBar.textContent = msg; voiceBar.classList.add('visible'); }
        function hideBar() { voiceBar.classList.remove('visible'); }
        function scrollEnd() { chatBox.scrollTop = chatBox.scrollHeight; }

        function clearEmpty() {
            const e = document.getElementById('emptyState');
            if (e) e.remove();
        }

        // ‚îÄ‚îÄ Add message row ‚îÄ‚îÄ
        function addMessage(text, sender) {
            clearEmpty();

            const row = document.createElement('div');
            row.className = `message ${sender}`;   // animation applied via CSS

            const av = document.createElement('div');
            av.className = 'msg-avatar';
            av.setAttribute('aria-hidden', 'true');
            av.textContent = sender === 'user' ? 'üë§' : 'ü§ó';

            const grp = document.createElement('div');
            grp.className = 'msg-group';

            const bub = document.createElement('div');
            bub.className = 'bubble';
            bub.textContent = text;

            const t = document.createElement('div');
            t.className = 'msg-time';
            t.textContent = clock();

            grp.appendChild(bub);
            grp.appendChild(t);
            row.appendChild(av);
            row.appendChild(grp);
            chatBox.appendChild(row);
            scrollEnd();
        }

        // ‚îÄ‚îÄ Typing indicator ‚îÄ‚îÄ
        function showTyping() {
            const id = 'ty-' + Date.now();
            const row = document.createElement('div');
            row.className = 'message bot typing-indicator';
            row.id = id;

            const av = document.createElement('div');
            av.className = 'msg-avatar';
            av.setAttribute('aria-hidden', 'true');
            av.textContent = 'ü§ó';

            const grp = document.createElement('div');
            grp.className = 'msg-group';

            const bub = document.createElement('div');
            bub.className = 'bubble';
            bub.innerHTML =
                '<span class="typing-label">Sentimate is typing</span>' +
                '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';

            grp.appendChild(bub);
            row.appendChild(av);
            row.appendChild(grp);
            chatBox.appendChild(row);
            scrollEnd();
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // ‚îÄ‚îÄ Suggestion chips ‚îÄ‚îÄ
        function suggest(text) { userInput.value = text; sendMessage(); }

        // ‚îÄ‚îÄ Send ‚îÄ‚îÄ
        async function sendMessage() {
            const msg = userInput.value.trim();
            if (!msg) {
                userInput.placeholder = 'Please type a message first!';
                userInput.focus(); return;
            }

            addMessage(msg, 'user');
            userInput.value = '';
            userInput.placeholder = 'Type your message here‚Ä¶';

            sendBtn.disabled = true;
            sendBtn.textContent = '‚Ä¶';
            micBtn.disabled = true;

            const tid = showTyping();

            try {
                const res = await fetch('/get_response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                removeTyping(tid);
                const botText = data.response || "I'm here with you. Tell me more.";
                addMessage(botText, 'bot');
                if (voiceOn) speak(botText, data.language || langSelect.value);
            } catch {
                removeTyping(tid);
                addMessage("I'm having a little trouble. Please try again!", 'bot');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send ‚û§';
                micBtn.disabled = false;
                userInput.focus();
            }
        }

        userInput.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !sendBtn.disabled) sendMessage();
        });

        // ‚îÄ‚îÄ Voice toggle ‚îÄ‚îÄ
        function toggleVoice() {
            voiceOn = !voiceOn;
            voiceToggle.textContent = voiceOn ? 'üîä Voice' : 'üîá Muted';
            voiceToggle.classList.toggle('active', voiceOn);
            voiceToggle.setAttribute('aria-pressed', String(voiceOn));
            if (!voiceOn) ttsAudio.pause();
        }

        // ‚îÄ‚îÄ TTS ‚îÄ‚îÄ
        async function speak(text, language) {
            try {
                const res = await fetch('/speak_response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, language: language || langSelect.value })
                });
                const data = await res.json();
                if (data.success && data.audio_b64) {
                    ttsAudio.src = 'data:audio/mpeg;base64,' + data.audio_b64;
                    ttsAudio.play().catch(() => { });
                }
            } catch { /* silent */ }
        }

        // ‚îÄ‚îÄ Language preference ‚îÄ‚îÄ
        async function loadLang() {
            try {
                const r = await fetch('/get_language');
                const d = await r.json();
                if (d.language) langSelect.value = d.language;
            } catch { }
        }
        async function saveLang(lang) {
            try {
                await fetch('/save_language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ language: lang })
                });
            } catch { }
        }
        langSelect.addEventListener('change', () => saveLang(langSelect.value));

        // ‚îÄ‚îÄ Speech recognition ‚îÄ‚îÄ
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { micBtn.style.opacity = '.45'; micBtn.title = 'Voice input requires Chrome.'; }

        function langCode(l) { return l === 'tamil' ? 'ta-IN' : 'en-US'; }

        function startRec() {
            if (!SR) { showBar('‚ö†Ô∏è Voice input requires Chrome.'); setTimeout(hideBar, 3000); return; }
            recognition = new SR();
            recognition.lang = langCode(langSelect.value);
            recognition.continuous = false;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('recording');
                micBtn.textContent = '‚èπ';
                sendBtn.disabled = true;
                showBar('üéôÔ∏è Listening‚Ä¶ speak now');
            };
            recognition.onresult = ev => {
                const t = Array.from(ev.results).map(r => r[0].transcript).join('');
                userInput.value = t;
                if (ev.results[ev.results.length - 1].isFinal) {
                    showBar(`‚úÖ Got: "${t}"`);
                    setTimeout(() => { hideBar(); if (t.trim()) sendMessage(); }, 600);
                } else {
                    showBar(`üéôÔ∏è Hearing: "${t}"`);
                }
            };
            recognition.onerror = ev => {
                const m = { 'no-speech': 'üîï No speech.', 'not-allowed': 'üö´ Mic denied.', 'network': 'üåê Network error.' };
                if (m[ev.error]) { showBar(m[ev.error]); setTimeout(hideBar, 3000); }
                stopRec();
            };
            recognition.onend = stopRec;
            recognition.start();
        }

        function stopRec() {
            isRecording = false;
            micBtn.classList.remove('recording');
            micBtn.textContent = 'üé§';
            sendBtn.disabled = false;
            if (recognition) { try { recognition.stop(); } catch { } recognition = null; }
        }

        function toggleMic() { isRecording ? (stopRec(), hideBar()) : startRec(); }

        // ‚îÄ‚îÄ Inactivity detection ‚îÄ‚îÄ
        let alertShown = false;

        function ping() {
            fetch('/update_activity', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: 'web_user' })
            }).catch(() => { });
        }

        function checkInactivity() {
            fetch('/check_inactivity').then(r => r.json()).then(d => {
                if (d.is_inactive && !alertShown) { alertShown = true; showAlert(d.message); }
                else if (!d.is_inactive) { alertShown = false; }
            }).catch(() => { });
        }

        function showAlert(message) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;';
            overlay.onclick = () => { overlay.remove(); box.remove(); ping(); };

            const box = document.createElement('div');
            box.style.cssText = [
                'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);',
                'background:rgba(255,255,255,.92);backdrop-filter:blur(18px);',
                'padding:40px;border-radius:28px;',
                'box-shadow:0 8px 40px rgba(127,161,255,.25);z-index:10000;',
                'max-width:460px;width:90%;text-align:center;font-family:inherit;'
            ].join('');
            box.innerHTML = `
        <div style="font-size:3.2em;margin-bottom:14px;">üíö</div>
        <h2 style="color:#7FA1FF;font-size:1.5em;margin-bottom:12px;font-family:'Lora',serif;">Just Checking In!</h2>
        <p style="color:#4a4f6b;font-size:1.1em;line-height:1.65;margin-bottom:28px;">${message}</p>
        <button onclick="this.closest('body').querySelectorAll('[style*=inset]').forEach(e=>e.remove());ping();"
            style="background:linear-gradient(135deg,#7FA1FF,#a8bfff);color:#fff;border:none;
                   border-radius:14px;padding:14px 32px;font-size:1.1em;font-weight:700;
                   cursor:pointer;font-family:inherit;box-shadow:0 4px 16px rgba(127,161,255,.35);">
            I'm Still Here üëã
        </button>`;

            document.body.appendChild(overlay);
            document.body.appendChild(box);
        }

        // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', () => { loadLang(); scrollEnd(); });
        window.addEventListener('load', () => {
            userInput.focus(); scrollEnd(); ping();
            ['click', 'keypress', 'mousemove'].forEach(e => document.addEventListener(e, ping));
            setInterval(checkInactivity, 60000);
        });
        loadLang(); scrollEnd();
    </script>

</body>

</html>